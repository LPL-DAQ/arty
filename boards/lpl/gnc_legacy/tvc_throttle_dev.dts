/*
GNC throttle + TVC flows board.
*/

/dts-v1/;

#include <../boards/pjrc/teensy4/teensy41.dts>

/ {
    model = "TVC/Throttle Dev Board";

    aliases {
        pt-adc = &adc1;
        fuel-valve-stepper-pulse-counter = &pit0_channel0;
        lox-valve-stepper-pulse-counter = &pit0_channel1;
    };

    zephyr,user {
        fuel-valve-stepper-pul-gpios = <&gpio2 0 GPIO_ACTIVE_HIGH>; // Pin 10
        fuel-valve-stepper-dir-gpios = <&gpio2 1 GPIO_ACTIVE_HIGH>; // Pin 12
        fuel-valve-stepper-ena-gpios = <&gpio2 2 GPIO_ACTIVE_HIGH>; // Pin 11
        fuel-valve-encoder-a-gpios = <&gpio4 6 GPIO_ACTIVE_HIGH>; // Pin 4
        fuel-valve-encoder-b-gpios = <&gpio4 8 GPIO_ACTIVE_HIGH>; // Pin 5

        lox-valve-stepper-pul-gpios = <&gpio2 0 GPIO_ACTIVE_HIGH>; // Pin 10
        lox-valve-stepper-dir-gpios = <&gpio2 1 GPIO_ACTIVE_HIGH>; // Pin 12
        lox-valve-stepper-ena-gpios = <&gpio2 2 GPIO_ACTIVE_HIGH>; // Pin 11
        lox-valve-encoder-a-gpios = <&gpio4 6 GPIO_ACTIVE_HIGH>; // Pin 4
        lox-valve-encoder-b-gpios = <&gpio4 8 GPIO_ACTIVE_HIGH>; // Pin 5

        // HACK: For whatever reason the io-channels may be getting auto-sorted? Thus, we order our pt labels
        // corresponding to the sorted ascending order of ADC1 channels. The following corresonds to pins A0, A1, A3,
        // and A2. We really ought investigate further.
        pt-names = "pt202", "pt203", "pt102", "ptf401";
        io-channels = <&adc1 5>, <&adc1 6>, <&adc1 7>, <&adc1 8>;
    };

    chosen {
        zephyr,console = &cdc_acm_uart0;
    };

    example_sensor: example-sensor {
        compatible = "zephyr,example-sensor";
        input-gpios = <&gpio6 18 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
    };

    blink_led: blink-led {
        compatible = "blink-gpio-led";
        led-gpios = <&gpio2 3 GPIO_ACTIVE_HIGH>;
        blink-period-ms = <1000>;
    };
};

// Docs: https://docs.zephyrproject.org/latest/build/dts/api/bindings/pinctrl/nxp%2Cmcux-rt-pinctrl.html
&pinctrl {
    pinmux_adc1: pinmux_adc1 {
        group0 {
            pinmux = <&iomuxc_gpio_ad_b1_00_gpio1_io16>,
                     <&iomuxc_gpio_ad_b1_00_gpio1_io16>,
                     <&iomuxc_gpio_ad_b1_01_gpio1_io17>,
                     <&iomuxc_gpio_ad_b1_03_gpio1_io19>;
            bias-disable; // These should be pulled down by voltage divider
            drive-strength = "r0-6";
            slew-rate = "slow";
            nxp,speed = "100-mhz";
        };
    };
};

// Docs: https://docs.zephyrproject.org/latest/build/dts/api/bindings/adc/nxp%2Cmcux-12b1msps-sar.html
pt_adc: &adc1 {
    // She's broken, he's...
    status = "okay";
    pinctrl-0 = <&pinmux_adc1>;
    pinctrl-names = "default";
    #address-cells = <1>;
    #size-cells = <0>;

    // PT1 (top-left), pin A0 / 14, AD_B1_02
    channel@5 {
        reg = <0x5>;
        zephyr,gain = "ADC_GAIN_1";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
        zephyr,resolution = <12>; // Max for chip
        zephyr,oversampling = <5>; // 32x averaging
    };

    // PT2 (bottom-left), pin A5 / 19, AD_B1_00
    channel@6 {
        reg = <0x6>;
        zephyr,gain = "ADC_GAIN_1";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
        zephyr,resolution = <12>; // Max for chip
        zephyr,oversampling = <5>; // 32x averaging
    };

    // PT4 (top-right), pin A1 / 15, AD_B1_03
    channel@7 {
        reg = <0x7>;
        zephyr,gain = "ADC_GAIN_1";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
        zephyr,resolution = <12>; // Max for chip
        zephyr,oversampling = <5>; // 32x averaging
    };

    // PT3 (bottom-right), pin A4 / 18, AD_B1_01
    channel@8 {
        reg = <0x8>;
        zephyr,gain = "ADC_GAIN_1";
        zephyr,reference = "ADC_REF_INTERNAL";
        zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
        zephyr,resolution = <12>; // Max for chip
        zephyr,oversampling = <5>; // 32x averaging
    };

    // TODO - add add'l analog-ins.
};

// Timer for stepper pulses.
// Docs: https://docs.zephyrproject.org/latest/build/dts/api/bindings/counter/nxp%2Cpit.html
// Teensyduino equivalent: https://sourcegraph.com/github.com/PaulStoffregen/cores/-/blob/teensy4/IntervalTimer.cpp
&pit0 {
    status = "okay";
};

&pit0_channel0 {
    status = "okay";
};

&zephyr_udc0 {
    cdc_acm_uart0: cdc_acm_uart0 {
        compatible = "zephyr,cdc-acm-uart";
        label = "CDC_ACM_0";
    };
};

&lpuart6 {
    status = "disabled";
};

&lpuart4 {
    status = "okay";
    current-speed = <115200>;
};
