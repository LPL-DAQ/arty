/*
LPL throttle dev 2.5 PCB, from spring/summer 2025.

To find the devicetree equivalent of a teensy GPIO pin:
    1) Find the SOC pin mapped to the teensy pin using the schematic: https://www.pjrc.com/teensy/schematic.html. For
       example, teensy pin 12 -> B0_01
    2) Examine the devicetree for the teensy SOC and find the gpio bank + index corresopnding to the SOC pin:
       https://sourcegraph.com/github.com/zephyrproject-rtos/zephyr/-/blob/dts/arm/nxp/nxp_rt1060.dtsi?L90-94.
       For example:
       B0_01 ->
       ...
         GPIO bank: &gpio2
         vvvvv
       &gpio2 {
           pinmux = <&iomuxc_gpio_b0_00_gpio2_io00>,
                <&iomuxc_gpio_b0_01_gpio2_io01>,
                              ^^^^^         ^^
                              Matching pin  Index 1
       ...
       Be careful, as some pins may have very similar names. Note how we selected `iomuxc_gpio_b0_01_gpio2_io01` rather
       than `iomuxc_gpio_sd_b0_01_gpio3_io13` due to the erroneous `sd_` prefix in that other pin name.
    3) Convert this to the device tree phandle.
       For example: <&gpio2 1 GPIO_ACTIVE_HIGH>
                      ^^^   ^ ^^^^^^^^^^^^^^^^
                      Bank  |   Other GPIO config flags
                            Index

To the find devicetree ADC channel for a teensy ADC pin:
    1) Check the teensy API for how they map teensy pins to ADC channels: https://sourcegraph.com/github.com/PaulStoffregen/cores/-/blob/teensy4/analog.c?L41-86.
       Note the channel number and ADC number. Numbers less than 128 are the channel number on ADC1 while numbers that
       are `128+XYZ` use channel number XYZ on ADC2.
    2)

*/

/dts-v1/;

#include <../boards/pjrc/teensy4/teensy41.dts>
#include <zephyr/dt-bindings/pwm/pwm.h>
#include <zephyr/dt-bindings/gpio/gpio.h>

/ {
	model = "Throttle Legacy Board";

	aliases {
		pt-adc = &adc1;
		stepper-pulse-counter = &qtmr1_timer0;
		/* Make this bus the default Arduino I2C bus for Wire */
		arduino-i2c = &lpi2c1;
		arduino_spi = &lpspi4;
		// might be this:
		// arduino-i2c = &lpi2c1
	};

	zephyr_user: zephyr,user {
		stepper-pul-gpios = <&gpio4 31 GPIO_ACTIVE_HIGH>; // Pin 29
		stepper-dir-gpios = <&gpio3 18 GPIO_ACTIVE_HIGH>; // Pin 28
		stepper-ena-gpios = <&gpio1 2 GPIO_ACTIVE_HIGH>; // Pin 4

		pwms = <&flexpwm2_pwm2 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>, /* tvc_x -> pin 6 (A) */
			   <&flexpwm4_pwm2 1 PWM_MSEC(20) PWM_POLARITY_NORMAL>, /* tvc_y -> pin 3 (B) */
			   <&flexpwm1_pwm3 1 PWM_MSEC(20) PWM_POLARITY_NORMAL>, /* esc_1 -> pin 7 (B) */
			   <&flexpwm2_pwm1 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>; /* esc_2 -> pin 5 (A) */

		pwm-names = "tvc_x", "tvc_y", "esc_1", "esc_2";

		servo-min-pulse-us = <1000>;
		servo-max-pulse-us = <2000>;

		// HACK: For whatever reason the io-channels may be getting auto-sorted? Thus, we order our pt labels
		// corresponding to the sorted ascending order of ADC1 channels. The following corresonds to pins A0, A1, A3,
		// and A2. We really ought investigate further.
		pt-names = "pt102", "pt202", "pt203", "ptf401";
		io-channels = <&adc1 7>, <&adc1 8>, <&adc1 11>, <&adc1 12>;

		/* GY-BNO08X IMU config */
		i2cs = <&lpi2c1>;
		imu_i2c_addr = <0x4b>;     /* default BNO08x I2C address */


		/* Minimal stub just so Arduino.h sees *something* */

		// 4 "Arduino digital pins" – for now just use 0..3 on gpio1 as placeholders.
		digital-pin-gpios = <&gpio1 0 GPIO_ACTIVE_HIGH>,
							<&gpio1 1 GPIO_ACTIVE_HIGH>,
							<&gpio1 2 GPIO_ACTIVE_HIGH>,
							<&gpio1 3 GPIO_ACTIVE_HIGH>;

		// 4 "Arduino analog pins" – one per ADC channel listed in io-channels.
		// These are just placeholders
		adc-pin-gpios     = <&gpio1 0 GPIO_ACTIVE_HIGH>,
							<&gpio1 1 GPIO_ACTIVE_HIGH>,
							<&gpio1 2 GPIO_ACTIVE_HIGH>,
							<&gpio1 3 GPIO_ACTIVE_HIGH>;

		// 4 PWM-capable "Arduino pins" - Just placeholders.
		pwm-pin-gpios     = <&gpio1 0 GPIO_ACTIVE_HIGH>,
							<&gpio1 1 GPIO_ACTIVE_HIGH>,
							<&gpio1 2 GPIO_ACTIVE_HIGH>,
							<&gpio1 3 GPIO_ACTIVE_HIGH>;

	};

	chosen {
		zephyr,console = &cdc_acm_uart0;
	};

	example_sensor: example-sensor {
		compatible = "zephyr,example-sensor";
		input-gpios = <&gpio6 18 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
	};

	blink_led: blink-led {
		compatible = "blink-gpio-led";
		led-gpios = <&gpio2 3 GPIO_ACTIVE_HIGH>;
		blink-period-ms = <1000>;
	};
};

// docs: https://www.pjrc.com/store/teensy41.html
/* Module 2, submodule 2 -> pins 6 (A) and 9 (B) */
/* tvc_x on pin 6 (A of FlexPWM2 submodule 2) */
&flexpwm2_pwm2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pwm2_2_a_b0_10>;
	status = "okay";
};


/* esc_1 on pin 7 (A of FlexPWM1 submodule 3) */
&flexpwm1_pwm3 {
	pinctrl-names = "default";
	pinctrl-0 = <&pwm1_3_b_b1_01>;
	status = "okay";
};

/* tvc_y on pin 3 (B of FlexPWM4 submodule 2) */
&flexpwm4_pwm2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pwm4_2_b_emc_05>;
	status = "okay";
};


/* esc_2 on pin 5 (A of FlexPWM2 submodule 1) */
&flexpwm2_pwm1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pwm2_1_a_emc_08>;
	status = "okay";
};

/* Enable I2C1 for the IMU */
&lpi2c1{

	pinctrl-names = "default";
	pinctrl-0 = <&i2c1>;
	clock-frequency = <400000>;  /* 400 kHz I2C */
	status = "okay";
};

/* Enable the SPI controller used for Arduino SPI */
&lpspi4 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&lpspi4_default>;
};

// Docs: https://docs.zephyrproject.org/latest/build/dts/api/bindings/pinctrl/nxp%2Cmcux-rt-pinctrl.html
&pinctrl {
	pinmux_adc1: pinmux_adc1 {
		group0 {
			pinmux = <&iomuxc_gpio_ad_b1_02_gpio1_io18>, <&iomuxc_gpio_ad_b1_03_gpio1_io19>,
					 <&iomuxc_gpio_ad_b1_06_gpio1_io22>, <&iomuxc_gpio_ad_b1_07_gpio1_io23>;
			bias-disable; // These should be pulled down by voltage divider
			drive-strength = "r0-6";
			slew-rate = "slow";
			nxp,speed = "100-mhz";
		};
	};


	/* GY-BNO08X IMU I2C1 pins (Teensy pins 18-19 on AD_B1_00/01) */
	i2c1: i2c1 {
		group0 {
				pinmux = <&iomuxc_gpio_ad_b1_00_lpi2c1_scl>, // pin 19
					 <&iomuxc_gpio_ad_b1_01_lpi2c1_sda>; // pin 18

			/* Usual I2C pin config */
			bias-pull-up;
			drive-strength = "r0-6";
			slew-rate = "slow";
			nxp,speed = "100-mhz";
		};
	};

	/* SPI on Teensy 4.1 pins 10–13: LPSPI4 */
	lpspi4_default: lpspi4_default {
		group0 {
			pinmux = <&iomuxc_gpio_b0_03_lpspi4_sck>,   /* Pin 13: SCK  */
					 <&iomuxc_gpio_b0_02_lpspi4_sdo>,   /* Pin 11: MOSI */
					 <&iomuxc_gpio_b0_01_lpspi4_sdi>,   /* Pin 12: MISO */
					 <&iomuxc_gpio_b0_00_lpspi4_pcs0>;  /* Pin 10: CS   */
		bias-disable;
		drive-strength = "r0-6";
		nxp,speed = "100-mhz";
		slew-rate = "slow";
	};
};

	/* Teensy 4.1 pin 6 -> GPIO_B0_10 -> FLEXPWM2_PWMA02 */
	pwm2_2_a_b0_10: pwm2_2_a_b0_10 {
		group0 {
			pinmux = <&iomuxc_gpio_b0_10_flexpwm2_pwma2>;
			bias-disable;
			drive-strength = "r0-6";
			slew-rate = "slow";
			nxp,speed = "100-mhz";
		};
	};

	/* pin 3 : GPIO_EMC_05 -> FLEXPWM4_PWMB02 */
	pwm4_2_b_emc_05: pwm4_2_b_emc_05 {
		group0 {
			pinmux = <&iomuxc_gpio_emc_05_flexpwm4_pwmb2>;
			bias-disable;
			drive-strength = "r0-6";
			nxp,speed = "100-mhz";
			slew-rate = "slow";
		};
	};

	/* pin 5 : GPIO_EMC_08 -> FLEXPWM2_PWMA01 */
	pwm2_1_a_emc_08: pwm2_1_a_emc_08 {
		group0 {
			pinmux = <&iomuxc_gpio_emc_08_flexpwm2_pwma1>;
			bias-disable;
			drive-strength = "r0-6";
			nxp,speed = "100-mhz";
			slew-rate = "slow";
		};
	};

//	/* Teensy 4.1 pin 9-> GPIO_B1_01 -> FLEXPWM1_PWMB03 */
//	pwm2_2_b_b0_11: pwm2_2_b_b0_11 {
//		group0 {
//			pinmux = <&iomuxc_gpio_b0_11_flexpwm2_pwmb2>;
//			bias-disable;
//			drive-strength = "r0-6";
//			slew-rate = "slow";
//			nxp,speed = "100-mhz";
//		};
//	};

	/* pin 7 : GPIO_B1_01 -> FLEXPWM1_PWMb03 */
	pwm1_3_b_b1_01: pwm1_3_b_b1_01 {
		group0 {
			pinmux = <&iomuxc_gpio_b1_01_flexpwm1_pwmb3>;
			bias-disable;
			drive-strength = "r0-6";
			nxp,speed = "100-mhz";
			slew-rate = "slow";
		};
	};

};

// Docs: https://docs.zephyrproject.org/latest/build/dts/api/bindings/adc/nxp%2Cmcux-12b1msps-sar.html
pt_adc: &adc1 {
	// She's broken, he's...
	status = "okay";
	pinctrl-0 = <&pinmux_adc1>;
	pinctrl-names = "default";
	#address-cells = <1>;
	#size-cells = <0>;

	// PT1 (top-left), pin A0 / 14, AD_B1_02
	channel@7 {
		reg = <0x7>;
		zephyr,gain = "ADC_GAIN_1";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
		zephyr,resolution = <12>; // Max for chip
		zephyr,oversampling = <5>; // 32x averaging
	};

	// PT2 (bottom-left), pin A1 / 15, AD_B1_03
	channel@8 {
		reg = <0x8>;
		zephyr,gain = "ADC_GAIN_1";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
		zephyr,resolution = <12>; // Max for chip
		zephyr,oversampling = <5>; // 32x averaging
	};

	// PT4 (top-right), pin A3 / 17, AD_B1_07
	channel@b {
		reg = <0xb>;
		zephyr,gain = "ADC_GAIN_1";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
		zephyr,resolution = <12>; // Max for chip
		zephyr,oversampling = <5>; // 32x averaging
	};

	// PT3 (bottom-right), pin A2 / 16, AD_B1_06
	channel@c {
		reg = <0xc>;
		zephyr,gain = "ADC_GAIN_1";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME_DEFAULT>;
		zephyr,resolution = <12>; // Max for chip
		zephyr,oversampling = <5>; // 32x averaging
	};

	// TODO - add add'l analog-ins.
};

// Timer for stepper pulses.
// Docs: https://docs.zephyrproject.org/latest/build/dts/api/bindings/counter/nxp%2Cimx-tmr.html
// Teensyduino equivalent: https://sourcegraph.com/github.com/PaulStoffregen/cores/-/blob/teensy4/IntervalTimer.cpp
&qtmr1_timer0 {
	status = "okay";
	mode = "kQTMR_PriSrcRiseEdge"; // Rising edge of primary clock source
	// Use instruction pointer clock, which is 600 MHz: https://sourcegraph.com/github.com/zephyrproject-rtos/zephyr/-/blob/dts/arm/nxp/nxp_rt10xx.dtsi?L75-79
	// These are 16-bit counters, so picking 32x clock division gets us a minimum width of ~53 ns and a maximum width of
	// ~3.5 ms. This more than covers our driver's minimum width of 2.5 us and our control loop's rough maximum interval
	// of 1 ms.
	primary-source = "kQTMR_ClockDivide_32";
};

&zephyr_udc0 {
	cdc_acm_uart0: cdc_acm_uart0 {
		compatible = "zephyr,cdc-acm-uart";
		label = "CDC_ACM_0";
	};
};

&lpuart6 {
	status = "disabled";
};

&lpuart4 {
	status = "okay";
	current-speed = <115200>;
};